(function(a){a.fn.extend({isChildOf:function(b){var c=a(this).parents().get();for(j=0;j<c.length;j++){if(a(c[j]).is(b)){return true}}return false}})})(jQuery);$(function(){var a=a||function(b){var c=[b.Collection.prototype,b.Model.prototype,b.View.prototype];var d={dispatcher:_.extend({},b.Events),events:function(){var c=_.clone(b.Events);var d=function(a){return!(a instanceof b.Model&&a.collection instanceof b.Collection)};return{dispatcher:a.dispacher,trigger:function(){var b=_.toArray(arguments);if(this._callbacks){c.trigger.apply(this,b)}if(d(this)){a.dispatcher.trigger.apply(a.dispatcher,b)}return this}}},extend:function(){var a=this;_.each(c,function(b){_.extend(b,a.events())})}};return d}(Backbone);a.extend();var b;b={container:"#container",container_admin:"#admin-entry-point",container_resources:"#container-resources",container_topics:"#container-topics",container_topic_desc:"#container-topic-desc",container_panel_mid:"#panel-medium",container_panel_big:"#panel-big",container_topic_tree:"#topic-tree",container_topic_info:"#topic-info",container_topic_mgt:"#topic-mgt",container_resource_mgt:"#resource-mgt",template_resource:"#resource-template",template_resource_note:"#resource-template-note",template_topic:"#topic-template",template_button:"#button-template",class_resource:"resource",class_topic:"topic",EVENTS:{TOPICPINNED:"topicpinned",GETPARENT:"getparent",SAVE:"savemodel",CONTROL:"showpanel",RIGHTMENU:"showmenu",GOTO:"goto"},msg:"#msg"};$("body").click(function(a){if(!($(a.target).isChildOf(".panel")||$(a.target).hasClass("panel"))){$(".panel:visible").fadeOut("fast")}});$(".fright").bind("mousewheel",function(a,c){a.preventDefault();var d,e,f,g,h,i;f=c>0?20:-20;h=$(b.container_topics).parent().height();g=$(b.container_topics).height();d=$(b.container_topics).offset().top;i=$(b.container_topics).parent().offset().top;e=d+f;if(g+d<i+h&&d<i){e=0;$(b.container_topics).animate({top:e});return}else if(e<=i&&g+e>=i+h){$(b.container_topics).offset({top:e})}});var c=$(".wrapper");var d=$(window).height()-c.offset().top;c.height(d);c=$(b.container_resources);d=$(window).height()-c.offset().top;c.height(d);$(b.container_topic_mgt).parent().hide();$(b.container_resource_mgt).parent().hide();var e=Backbone.Model.extend({defaluts:{event:"SOMEBUTTONCLICKED",text:"A Simple Button"},enabled:true});var f=Backbone.Model.extend({defaults:{title:"A Sample Resource",link:"#",topic_id:null,type:"tut",note:"Some note texts"},initialize:function(){this.shorten()},shorten:function(){var a,b;a=this.get("title");b=a.substring(0,35);if(a!==b)b=b+"...";this.set({dtitle:b})},destroy:function(a){a=a?_.clone(a):{};var b=this;var c=a.success;var d=function(){b.trigger("destroy",b,b.collection,a)};d();return false}});var g=Backbone.Collection.extend({model:f});var h=Backbone.Model.extend({defaults:{name:"A Topic",description:"a topic here",subtopics:null,resources:null},initialize:function(a){this.set({subtopics:a.subtopics||new Array});this.set({resources:a.resources||new Array});_.bindAll(this,"simpleJSON","all_toJSON");AllTopics.add(this)},attachSubtopics:function(a){var b=this.get("subtopics");if(!a){a=_.clone(b)}b.splice(0,b.length);if(a instanceof Array&&a.length){_.each(a,function(a){if(a instanceof h){this.addChildren(a)}else if(a instanceof Object){var b=new h(a);this.addChildren(b);b.attachSubtopics()}},this)}return this},addChildren:function(a){if(!(a instanceof Array)){a=[a]}var b,c,d;b=0;c=this.get("subtopics");d=this.get("resources");_.each(c,function(a){if(!(a instanceof h)){a=AllTopics.getByCid(a.cid)}},this);_.each(a,function(a){if(a instanceof h){c.push(a);b++}else if(a instanceof f){d.push(a)}},this);if(b){root.trigger("change",b)}return this},hasResourcesAttached:function(){return this.get("resources").length},hasSubtopicsAttached:function(){return this.get("subtopics").length},getResources:function(a){a=typeof a=="undefined"?[]:a;var b=this.get("subtopics");var c=this.get("resources");if(!c.length){return a}a=a.concat(this.get("resources"));if(!b.length){return a}_.each(b,function(b){a=b.getResources(a)},this);return a},getSubs:function(){var a=this.get("subtopics");if(a instanceof i){return a.models}else{return a}},simpleJSON:function(a){var b={};b.cid=this.cid;b.name=this.get("name");b.subtopics=this.getSubs();if(typeof a!="undefined"){b.resourcecount=this.hasResourcesAttached();b.subtopiccount=this.hasSubtopicsAttached()}return b},all_toJSON:function(a){a=typeof a=="undefined"?this:a;var b,c;if(a instanceof h){a=a.simpleJSON()}for(var d=0;d<a.subtopics.length;d++){var c=a.subtopics[d];a.subtopics[d]=this.all_toJSON.call(this,c)}return a}});var i=Backbone.Collection.extend({model:h});var j=Backbone.Model.extend({initialize:function(){_.bindAll(this,"load","getType")},renderOpts:{className:"",number:"input:number",string:"input",format:"table"},load:function(a){this.set(this.getType(a));this._Model=a;return this},getType:function(a){if(!a instanceof Object){a={}}else if(a.prototype&&a.prototype.defaults){a=_.clone(a.prototype.defaults)}for(key in a){if(a[key]instanceof Object){a[key]=this.getType(a[key])}else{a[key]=typeof a[key]}}return a},ignore:function(a){if(typeof a=="string"){a=[a]}var b=true;_.each(a,function(a){if(this.ignore[a]){b=b&&true}else{this.ignore[a]=true;b=false}},this);return b},isIgnored:function(a){if(typeof a=="string"){a=[a]}var b=true;_.each(a,function(a){if(this.ignore[a]){b=b&&true}else{b=false}},this);return b},include:function(a){if(typeof a=="undefined"){a=this.attributes}if(typeof a=="string"){a=[a]}_.each(a,function(a){if(this.ignore[a]){this.ignore[a]=null}},this)}});var k=j.extend({initialize:function(){_.bindAll(this,"load","getType");this.load(h).ignore(["subtopics","resources"])},renderOpts:{className:"topic",number:"input:number",description:"textarea",name:"input",customize:"features",format:"table"}});var l=j.extend({initialize:function(){_.bindAll(this,"load","getType");this.load(f).ignore("topic_id")},renderOpts:{className:"topic",number:"input:number",string:"input",note:"textarea",title:"input",customize:"features",format:"table"}});var n=function(a){this.email=a};n.prototype={admin:function(){return window.user_is_admin}};var o=function(){};o.prototype={hi:function(){console.log("You got me:",this)},currTgt:null,del:function(a,b){},bindAllEvents:function(){_.bindAll(this,"pinTopic","parentLookup","makeAndSave","loadResourcesOf","getRoot","globalControl");a.dispatcher.bind(b.EVENTS.TOPICPINNED,this.pinTopic);a.dispatcher.bind(b.EVENTS.GETPARENT,this.parentLookup);a.dispatcher.bind(b.EVENTS.SAVE,this.makeAndSave);a.dispatcher.bind(b.EVENTS.CONTROL,this.globalControl);a.dispatcher.bind(b.EVENTS.GOTO,this.redirect)},pinTopic:function(a){this.currTgt=a},parentLookup:function(a){a.findParent(this.currTgt)},makeAndSave:function(a,b){if(a.model._Model==h){var c=this.urls.new_topic}else if(a.model._Model==f){var c=this.urls.new_resource}else{return"Invaid Save Request."}var d=a.collect();b.btn.enabled=false;var e=a.findParent();if(!e){if(c==this.urls.new_topic){c=this.urls.new_subject}else{b.btn.enabled=true;return"Resource needs a parent."}delete d.parent_id}a.clearForm();$.getJSON(c,d,function(c){if(c.status=="success"){d.id=c.response.topic_id||c.response.resource_id;a.makeModel(d)}else if(c.status=="forbidden"){D.msg("Access Denied.")}else{console.log(c)}b.btn.enabled=true})},"delete":function(a,b){if(a instanceof h){var c=function(b){if(b.response.deleted==a.id){location.reload()}}}else if(a instanceof f){var c=function(c){if(c.status=="success"){if(c.response.deleted==a.id){var d=AllTopics.get(a.get("topic_id"));var e=d.get("resources").indexOf(a);if(e>-1){d.get("resources").splice(e,1)}if(b instanceof s){b.clear()}a.destroy()}}else if(c.status=="forbidden"){D.msg("Access Denied.")}else{console.log(c)}}}else{return}console.log(a);var d="obj_id="+a.id;$.getJSON(this.urls.delete,d,c)}};var p=function(c){this.user=c;if(c.admin()){_.extend(this,o.prototype);this.bindAllEvents()}else{for(m in o.prototype){this[m]=function(){console.log("You do not own me");D.msg("You are not admin.");return false}}a.dispatcher.bind(b.EVENTS.CONTROL,this.globalControl);a.dispatcher.bind(b.EVENTS.GOTO,this.redirect)}};p.prototype={urls:{root:"/api/get_topic_tree",new_topic:"/api/create_topic",new_subject:"/api/create_subject",new_resource:"/api/create_resource",load_resources:"/api/load_resources","delete":"/api/delete"},getRoot:function(){window.AllTopics=AllTopics||new i;window.Gallery=Gallery||new u;window.NoteArea=NoteArea||new t;window.TopicArea=TopicArea||new x;window.topicForm=topicForm||new k;window.resourceForm=resourceForm||new l;window.topicFormView=topicFormView||new A({model:topicForm});window.resourceFormView=resourceFormView||new B({model:resourceForm});$(b.container).hide();this.msg("Loading...");var a=this;$.getJSON(this.urls.root,function(c){if(c.status=="success"){if(window.root&&AllTopics){AllTopics.each(function(a){a.destroy()})}window.root=new h(c.response);root.attachSubtopics()}else{window.root=root||new h({description:"",name:"ROOT",subtopics:[]})}window.TopicBrowser=new w({model:root});topicFormView.render();resourceFormView.render();$(b.container).show();a.msg("Ready.","off")})},loadResourcesOf:function(a){if(!(a instanceof Array)){a=[a]}var b=function(a){return a.id||null};var c=_.map(a,b);var d="topic_ids="+c.join("&topic_ids=");var e=this;e.msg("loading resources...");$.getJSON(this.urls.load_resources,d,function(a){if(a.status=="success"){e.matchResources(a.response.resources)}else{return"Failed to load resources"}e.msg("Done.","off")})},matchResources:function(a){if(!AllTopics){return}if(!(a instanceof Array)){a=[a]}var b,c,d,e,g;_.each(a,function(a){d=a instanceof f?a:new f(a)||null;b=a.topic_id||null;c=AllTopics.get(b)||null;if(c&&d){e=c.get("resources");g=_.map(e,function(a){return a.cid||null});if(g.indexOf(d.cid)==-1){c.addChildren(d);c.trigger("resourcesadded",d,c)}}},this)},msg:function(a,c){a=a||"_";if(c){$(b.msg).html(a).fadeOut("slow")}else{$(b.msg).html(a).show()}},globalControl:function(a){$(a).toggle(600)},redirect:function(a){window.open(a,"_self")}};var q=Backbone.View.extend({el:"#menu",initialize:function(){_.bindAll(this,"display");this.bind(b.EVENTS.RIGHTMENU,this.display);this.who=null},events:{"click button":"onClickHandler"},display:function(a,b){$(this.el).css({left:a.pageX+"px",top:a.pageY+"px"}).show();this.who=b},onClickHandler:function(a){var b=$(a.target).attr("name");var c=this[b](a)||null;if(c){$(c.el).hide()}},describe:function(a){this.who.shownote(a);return this},remove:function(a){this.who.clear(a);return this},open:function(a){window.open(this.who.model.get("link"));return this},del:function(a){D.delete(this.who.model,this.who);return this}});var r=Backbone.View.extend({tagName:"button",className:"btn",initialize:function(){this.btn=new e;this.args=this.btn},events:{click:"clicked"},render:function(){$(this.el).html(this.btn.get("text"));return this},clicked:function(a){a.preventDefault();a.stopPropagation();if(this.btn["enabled"]){this.trigger(this.btn.get("event"),this.args,this)}}});var s=Backbone.View.extend({className:b.class_resource,template:_.template($(b.template_resource).html()),initialize:function(){this.render()},events:{"contextmenu .icon":"showmenu","click .icon":"shownote","click .close":"clear",mouseover:"showicons",mouseout:"hideicons"},render:function(){$(this.el).html(this.template(this.model.toJSON()));return this},toggleHighlight:function(){this.$(".title a").toggleClass("highlight")},shownote:function(a){a.stopPropagation();a.preventDefault();NoteArea.model=this.model;$(NoteArea.render().el).show()},showmenu:function(a){a.stopPropagation();a.preventDefault();menu.trigger(b.EVENTS.RIGHTMENU,a,this)},showicons:function(a){this.$(".circle").removeClass("hide")},hideicons:function(a){this.$(".circle").addClass("hide")},clear:function(a){Gallery.resources.remove(this.model)}});var t=Backbone.View.extend({el:b.container_panel_mid,template:_.template($(b.template_resource_note).html()),initialize:function(){this.model=new f},events:{},render:function(){$(this.el).html(this.template(this.model.toJSON()));return this},hide:function(){}});var u=Backbone.View.extend({el:b.container_resources,initialize:function(){this.resources=new g;this.resourceViews={};_.bindAll(this,"addMore","del");this.resources.bind("add",this.addMore);this.resources.bind("remove",this.del)},render:function(){$(this.el).empty();var a=this;this.resources.each(function(b){var c=a.resourceViews[b.cid];$(a.el).append(c.render().el)});return this},addMore:function(a){var b=this.resourceViews[a.cid];if(!b){var b=new s({model:a});this.resourceViews[a.cid]=b}$(this.el).append(b.render().el)},del:function(a){this.resourceViews[a.cid].remove();delete this.resourceViews[a.cid]}});var v=Backbone.View.extend({className:b.class_topic,template:_.template($(b.template_topic).html()),initialize:function(){if(this.model.hasResourcesAttached()){Gallery.resources.add(this.model.get("resources"))}_.bindAll(this,"onResourcesAdded","clear");this.model.bind("resourcesadded",this.onResourcesAdded)},onResourcesAdded:function(a){Gallery.resources.add(a);this.render()},events:{"click ":"hlResources","click .close":"clear"},render:function(){$(this.el).html(this.template(this.model.simpleJSON(1)));this.delegateEvents(this.events);return this},hlResources:function(){if(this.model.hasResourcesAttached()){_.each(this.model.get("resources"),function(a){try{Gallery.resourceViews[a.cid].toggleHighlight()}catch(b){}},this)}$(this.el).toggleClass("highlight");$(b.container_topic_desc).empty().html(this.model.get("description"))},clear:function(a){a.stopPropagation();a.preventDefault();this.model.unbind("resourcesadded",this.onResourcesAdded);if(this.model.hasResourcesAttached()){Gallery.resources.remove(this.model.get("resources"))}TopicArea.topics.remove(this.model);$(this.el).remove()}});var w=v.extend({el:b.container_panel_big,className:b.class_topic,initialize:function(){_.bindAll(this,"update");this.update();this.model.bind("change",this.update)},labels:{check:"icon-check",uncheck:"nothing",fold:"icon-folder-open",unfold:"icon-folder-close",pin:"icon-pushpin"},events:{"click span":"toggleSubtopics","click .close":"hide","click .refresh":"update","click a":"easySelect","click button.round":"tabview","mousedown a":"pin","click .done":"done"},update:function(){this.modelObj=this.model.all_toJSON();this.render()},render:function(){var a,c,d;a=JSON.stringify(this.modelObj);a=a.replace(/(,*){"cid":/g,'<li><a href="#" id=');a=a.replace(/,"name":"/g,">");a=a.replace(/}/g,"</li>");a=a.replace(/","subtopics":\[/g,'</a><ul class="topic">');a=a.replace(/\]/g,"</ul>");a=a.replace(/\<ul class="topic"\>\<\/ul\>/g,"");c=$(a);c.find("a").addClass(this.labels.uncheck);d='<span class="'+this.labels.fold+'"></span>';c.find("ul").parent().prepend(d);$(b.container_topic_tree).empty();c.appendTo(b.container_topic_tree);$(this.el).height(c.height()+100)},hide:function(){$(this.el).fadeOut("fast")},showAll:function(){this.$("hide").removeClass("hide");this.$(this.labels.unfold).removeClass(this.labels.unfold).addClass(this.labels.fold)},toggleSubtopics:function(a){$(a.target).parent().find("ul").toggleClass("hide");$(a.target).toggleClass(this.labels.fold).toggleClass(this.labels.unfold)},done:function(){this.hide();var a,b,c;b="."+this.labels.check;c=[];this.$(b).each(function(){a=AllTopics.getByCid($(this).attr("id"));previous=TopicArea.topics.getByCid($(this).attr("id"));if(!(a.get("name")=="ROOT"||previous)){try{TopicArea.topics.add(a,{silent:true});TopicArea.topics.trigger("include",a);if(!a.hasResourcesAttached()){c.push(a)}}catch(b){console.log(b);console.log("TOPIC-AREA:",TopicArea.topics)}}});return c.length==0||D.loadResourcesOf(c)},easySelect:function(a){a.stopPropagation();a.preventDefault();if($(a.target).hasClass(this.labels.check)){$(a.target).removeClass(this.labels.check);$(a.target).addClass(this.labels.uncheck);return}else{$(a.target).parent().find("a").removeClass(this.labels.uncheck);$(a.target).parent().find("a").addClass(this.labels.check)}},pin:function(a){a.stopPropagation();a.preventDefault();this.$("a").removeClass(this.labels.pin);if($(a.target).hasClass(this.labels.uncheck)){$(a.target).addClass(this.labels.pin)}var c=AllTopics.getByCid($(a.target).attr("id"));var d="<p><i>"+c.get("name")+"</i></p>"+"<p>"+c.get("description")+"</p>";$(b.container_topic_info).html(d);this.trigger("topicpinned",c)},tabview:function(a){a.stopPropagation();a.preventDefault();if($(a.target).attr("id")=="tab-topic"){$(b.container_topic_mgt).parent().show();$(b.container_resource_mgt).parent().hide()}else{$(b.container_topic_mgt).parent().hide();$(b.container_resource_mgt).parent().show()}}});var x=Backbone.View.extend({el:b.container_topics,initialize:function(){this.topics=new i;_.bindAll(this,"addMore");this.topics.bind("include",this.addMore)},render:function(){},events:{},addMore:function(a){if(typeof a.get("isIncludedAs")=="undefined"){var b=new v({model:a});a.set({isIncludedAs:b})}else{var b=a.get("isIncludedAs")}$(this.el).append(b.render().el);return this}});var y=Backbone.View.extend({initialize:function(){if(D.user.admin()){$(b.container_panel_big).css({right:0})}this._bt1=new r({className:"btn icon-cog"});this._bt1.args=b.container_panel_big;this._bt1.btn.set({text:"Browse Topics",event:b.EVENTS.CONTROL});this._bt2=new r({className:"btn icon-user"});this._bt2.args=window.login_url;var a=window.user_is_admin?C.email:"Login (Not Sign-up)";this._bt2.btn.set({text:a,event:b.EVENTS.GOTO});this._bt3=new r({className:"btn icon-github-sign"});this._bt3.args="https://github.com/yiransheng/learningcurve";this._bt3.btn.set({text:"See it on Github",event:b.EVENTS.GOTO})},events:{},render:function(){$(this.el).append(this._bt3.render().el);$(this.el).append(this._bt2.render().el);$(this.el).append(this._bt1.render().el)}});var z=Backbone.View.extend({initialize:function(a){_.bindAll(this,"table");if(a.renderOpts){_.extend(this.model.renderOpts,a.renderOpts)}this.renderOpts=this.model.renderOpts},events:{},render:function(){var a=this[this.renderOpts["format"]];if(!a){console.log("Format not supported in",this);return this}var b=a.call(this);$(this.el).html(b);var c=this.renderOpts["customize"];if(c){a=this[c]||function(){return""}}else{return this}a.call(this);return this},table:function(){var a,b,c;a=this.model;b='<table class="';b+=this.renderOpts.className;b+='"><tbody>';for(attr in a.attributes){if(!a.isIgnored(attr)){b+="<tr><td>";b+=attr;b+="</td><td>";c=this.renderOpts[attr]||this.renderOpts[this.model.get(attr)]||"";c=c+":::";c=c.split(":");c="<"+c[0]+' type="'+c[1]+'" class="'+c[2]+'" name="'+attr+'" />';b+=c;b+="</td></tr>"}}b=b+"</tbody></table>";return b},collect:function(){var a,b,c;b={};a=this.model.attributes;for(attr in a){if(!this.model.isIgnored(attr)){c=this.$('[name="'+attr+'"]').attr("value");b[attr]=c.toString()||""}}return b},clearForm:function(){this.$("input").attr("value","");this.$("textarea").attr("value","")}});var A=z.extend({initialize:function(a){_.bindAll(this,"table","findParent");if(a.renderOpts){_.extend(this.model.renderOpts,a.renderOpts)}this.renderOpts=this.model.renderOpts},events:{},features:function(){var a;a=new r({className:"btn icon-pushpin"});a.args=this;a.btn.set({event:b.EVENTS.GETPARENT,text:"Set Parent"});$(this.el).prepend('<div class="parent"> </div>');$(this.el).prepend(a.render().el);a=new r({className:"btn icon-file"});a.args=this;a.btn.set({event:b.EVENTS.SAVE,text:"Save"});$(this.el).prepend(a.render().el);$(this.el).prepend("<h2>Create a new topic:</h2>");$(b.container_topic_mgt).append(this.el)},findParent:function(a){if(!a){return this.parent_model.id||null}this.parent_model=a;this.$(".parent").html(a.get("name")).attr("id",a.id);return this},collect:function(){var a;a=z.prototype.collect.call(this);a.parent_id=this.findParent();return a},makeModel:function(a){delete a.parent_id;var b=new this.model._Model(a);this.parent_model.addChildren(b)}});var B=A.extend({features:function(){var a;a=new r({className:"btn icon-pushpin"});a.args=this;a.btn.set({event:b.EVENTS.GETPARENT,text:"Set Parent"});$(this.el).prepend('<div class="parent"> </div>');$(this.el).prepend(a.render().el);a=new r({className:"btn icon-file"});a.args=this;a.btn.set({event:b.EVENTS.SAVE,text:"Save"});$(this.el).prepend(a.render().el);$(this.el).prepend("<h2>Create a new resource:</h2>");$(b.container_resource_mgt).append(this.el)},makeModel:function(a){delete a.parent_id;var b=new this.model._Model(a);this.parent_model.addChildren(b);this.parent_model.trigger("resourcesadded",b,this.parent_model)}});console.log("Running..");$(b.container).hide();var C=new n(window.user_email);var D=new p(C);var E=new y({el:b.container_admin});E.render();window.AllTopics=new i;window.Gallery=new u;window.NoteArea=new t;window.TopicArea=new x;window.topicForm=new k;window.resourceForm=new l;window.topicFormView=new A({model:topicForm});window.resourceFormView=new B({model:resourceForm});window.menu=new q;D.getRoot()})
